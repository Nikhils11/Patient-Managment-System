pipeline {
    agent any

    tools {
        maven 'Maven'
        jdk 'JDK 21'
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                url: 'https://github.com/Nikhils11/Patient-Managment-System.git'
            }
        }

        stage('Build') {
            steps {
                sh 'mvn clean compile'
            }
        }

        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }

        stage('Package') {
            steps {
                sh 'mvn package'
            }
        }

        stage('Merge PR') {
            when {
                expression { env.CHANGE_ID != null }
            }

            steps {
                withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {

                    script {

                        def repoUrl = env.GIT_URL

                        def parts = repoUrl.replace(".git", "").tokenize('/')

                        def owner = parts[-2]
                        def repo = parts[-1]

                        def prNumber = env.CHANGE_ID

                        sh """
                        curl -X PUT \
                        -H "Authorization: token ${GITHUB_TOKEN}" \
                        -H "Accept: application/vnd.github+json" \
                        https://api.github.com/repos/${owner}/${repo}/pulls/${prNumber}/merge
                        """

                    }
                }
            }
        }

    }

    post {

        success {
            echo 'Build Success'
        }

        failure {
            echo 'Build Failed'
        }

    }
}
